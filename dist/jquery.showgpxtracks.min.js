/*! jQuery Gpx Viewer - v0.0.1 - 2014-10-30
* Copyright (c) 2014 kssfilo; Licensed MIT */
!function(a){a.fn.showGpxTracks=function(){this.each(function(){function b(b,c){a.ajax({url:b,type:"GET",dataType:"xml",timeout:2e4,error:function(a){c(a)},success:function(b){var d=[];a(b).find("trkpt").each(function(){var b=new Date(a(this).find("time").text());d.push({lt:parseFloat(a(this).attr("lat")),lg:parseFloat(a(this).attr("lon")),ev:parseFloat(a(this).find("ele").text()),tm:b})}),c(null,d)}})}var c=this,d=a(this).attr("src"),e=200,f=30;b(d,function(b,g){if(b)return void console.log(b);var h=a('<div style="width:100%;height:70%">'),i=a('<canvas style="width:100%;height:20%">'),j=a('<div style="width:100%;height:10%;font-size:12px">');h.appendTo(c),i.appendTo(c),j.appendTo(c);var k=i[0].getContext("2d");i[0].width=i[0].offsetWidth,i[0].height=i[0].offsetHeight;var l=i[0].width-f,m=i[0].width;l=m;var n=i[0].height,o=new google.maps.Map(h[0]);o.setOptions({scrollwheel:!0,draggable:!0,panControl:!0,mapTypeId:google.maps.MapTypeId.HYBRID});for(var p=[],q=0,r=90,s=180,t=0,u=1e5,v=0,w=0,x=null,y=0,z=0,A=0;A<g.length;A++){A>0&&(g[A].ev=.9*g[A-1].ev+.1*g[A].ev),q=g[A].lt>q?g[A].lt:q,r=g[A].lt<r?g[A].lt:r,s=g[A].lg<s?g[A].lg:s,t=g[A].lg>t?g[A].lg:t,u=Math.min(g[A].ev,u),v=Math.max(g[A].ev,v);var B=new google.maps.LatLng(g[A].lt,g[A].lg);if(p.push(B),0!==A){var C=google.maps.geometry.spherical.computeDistanceBetween(B,x);w+=C,g[A].dt=w,g[A-1].ev<g[A].ev&&(y+=g[A].ev-g[A-1].ev),g[A-1].ev>g[A].ev&&(z+=g[A-1].ev-g[A].ev)}x=B}var D=v-u;D=Math.max(D,e);var E=new google.maps.Polyline({path:p,strokeColor:"#FF0000",strokeWeight:2,strokeOpacity:.9});E.setMap(o);var F=new google.maps.LatLngBounds(new google.maps.LatLng(r,s),new google.maps.LatLng(q,t));o.fitBounds(F);var G=l/w,H=n/D;for(k.fillStyle="white",k.fillRect(0,0,l,n),k.strokeStyle="lightgray",k.lineWidth=1,A=0;4>A;A++)k.beginPath(),k.moveTo(0,n/4*A),k.lineTo(l-1,n/4*A),k.closePath(),k.stroke();for(k.fillStyle="black",k.beginPath(),k.moveTo(l-1,n-1),k.lineTo(0,n-1),k.lineTo(0,n-1-(g[0].ev-u)*H),A=1;A<g.length;A++)k.lineTo(G*g[A].dt-1,n-1-H*(g[A].ev-u));k.lineTo(l-1,n-1),k.closePath(),k.fill(),k.strokeStyle="black",k.lineWidth=2,k.strokeRect(1,1,l-2,n-2),k.fillStyle="blue",k.textAlign="left",k.font="12px Ariel",k.shadowBlur=1,k.shadowColor="white",k.fillText("+"+Math.round(D)+"m",5,16),k.fillText(""+Math.round(u)+"m",5,n-6);var I="Distance:"+Math.round(w)/1e3+"km/Low:"+Math.round(u)+"m/High:"+Math.round(v)+"m/Accent:+"+Math.round(y)+"m/Descent:"+Math.round(z)+"m";I+="[<a href='"+d+"' download>Download GPX</a>] (c)<a href='http://kanasys.com/gtech/'>kanasys.com</a>",j.html(I)})})}}(jQuery);